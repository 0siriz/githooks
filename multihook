#!/usr/bin/env bash

# Put into the directory specified by core.hooksPath or just `.git/hooks/`
# Then symlink each hookname to this script
# Hooks go in `HOOKNAME.d/` e.g. `pre-commit.d/00-hook1`, order is (from the location of this script)
# - $GIT_DIR/hooks/HOOKNAME
# - $GIT_DIR/hooks/HOOKNAME.d/*
# - $GIT_CUSTOM_HOOKS_DIR/HOOKNAME.d/*
# - ./HOOKNAME.d/*

set -eEu -o pipefail
shopt -s inherit_errexit

BOLD="\e[1m"
RED="\e[31m"
GREEN="\e[32m"
YELLOW="\e[33m"
MAGENTA="\e[35m"
CYAN="\e[36m"
RESET="\e[0m"

# optional debug output by TRACE=1
[[ "${TRACE:-0}" == "1" ]] && set -o xtrace
IFS=$'\n\t'
PS4='+\t '

STDIN=$(cat)

[[ -n "${GIT_DIR:-}" ]] && git_dir="$GIT_DIR"
unset $(git rev-parse --local-env-vars || true)
GIT_DIR="$(git rev-parse --git-dir 2>/dev/null)" || GIT_DIR="$git_dir"
export GIT_DIR
[[ -n "${git_dir:-}" ]] && unset git_dir

declare -a HOOKDIRS
HOOKDIRS+=("$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")
[[ -n "${GIT_CUSTOM_HOOKS_DIR:-}" ]] && HOOKDIRS+=("$GIT_CUSTOM_HOOKS_DIR")
HOOKDIRS+=("$GIT_DIR/hooks")

HOOKNAME=$(basename "${BASH_SOURCE[0]}")

echo -e "${BOLD}${CYAN}----- RUNNING ${HOOKNAME^^} HOOKS ${RESET} -----\n"

# Run first hooks in $GIT_DIR as usual (unless that is us)
hookscript="${GIT_DIR}/hooks/${HOOKNAME}"
if [[ -f "$hookscript" && -x "$hookscript" && ! "$hookscript" -ef "${BASH_SOURCE[0]}" ]]; then
	echo -e "${BOLD}${YELLOW}##### DEFAULT GITHOOK: $(echo "${hookscript}" | sed "s|^${HOME}|~|")${RESET}"
	echo "$STDIN" | "$hookscript" "$@" || exit $?
	echo ""
fi

declare -A TO_RUN

for dir in "${HOOKDIRS[@]}"; do
	hookdir="${dir}/${HOOKNAME}.d"
	if [[ -d "$hookdir" ]]; then
		for hook in "$hookdir"/*; do
			hookname="$(basename "$hook")"
			TO_RUN[$hookname]="$hook"
		done
	fi
done

for key in "${!TO_RUN[@]}"; do
	echo "$key"
done | sort | while read -r hookname; do
hookscript="${TO_RUN[$hookname]}"
if [[ -f "$hookscript" && -x "$hookscript" ]]; then
	echo -e "${BOLD}${MAGENTA}##### GITHOOK: $(echo "${hookscript}" | sed "s|^${HOME}|~|")${RESET}"
	echo "$STDIN" | "$hookscript" "$@" || exit $?
	echo ""
fi
done

echo -e "${BOLD}${GREEN}----- ALL ${HOOKNAME^^} HOOKS DONE${RESET} -----\n"
