#!/usr/bin/env bash

# Put into the directory specified by core.hooksPath or just `.git/hooks/`
# Then symlink each hookname to this script
# Hooks go in `HOOKNAME.d/` e.g. `pre-commit.d/00-hook1`, order is (from the location of this script)
# - $GIT_DIR/hooks/HOOKNAME
# - $GIT_DIR/hooks/HOOKNAME.d/*
# - $GIT_CUSTOM_HOOKS_DIR/HOOKNAME.d/*
# - ./HOOKNAME.d/*

set -eEu -o pipefail
shopt -s inherit_errexit

BOLD="\e[1m"
RED="\e[31m"
GREEN="\e[32m"
YELLOW="\e[33m"
MAGENTA="\e[35m"
CYAN="\e[36m"
RESET="\e[0m"

# optional debug output by TRACE=1
[[ "${TRACE:-0}" == "1" ]] && set -o xtrace
IFS=$'\n\t'
PS4='+\t '

STDIN=$(cat)

[[ -n "${GIT_DIR:-}" ]] && git_dir="$GIT_DIR"
unset $(git rev-parse --local-env-vars || true)
GIT_DIR="$(git rev-parse --git-dir 2>/dev/null)" || GIT_DIR="$git_dir"
export GIT_DIR
[[ -n "${git_dir:-}" ]] && unset git_dir

declare -a HOOKDIRS
HOOKDIRS+=("$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)")
[[ -n "${GIT_CUSTOM_HOOKS_DIR:-}" ]] && HOOKDIRS+=("$GIT_CUSTOM_HOOKS_DIR")
HOOKDIRS+=("$GIT_DIR/hooks")

HOOKNAME=$(basename "${BASH_SOURCE[0]}")

echo -e "${BOLD}${CYAN}----- RUNNING ${HOOKNAME^^} HOOKS ${RESET} -----\n"

declare -A TO_RUN

for dir in "${HOOKDIRS[@]}"; do
	hookdir="${dir}/${HOOKNAME}.d"
	if [[ -d "$hookdir" ]]; then
		for hook in "$hookdir"/*; do
			hookname="$(basename "$hook")"
			TO_RUN[$hookname]="$hook"
		done
	fi
done

declare -a FAILED=()

while read -r hookname; do
	hookscript="${TO_RUN[$hookname]}"
	if [[ -f "$hookscript" && -x "$hookscript" ]]; then
		hookname="$hookscript"
		[[ "$hookname" =~ ^"$HOME"(/|$) ]] && hookname="~${hookname#$HOME}"
		exit_code=0
		echo -e "${BOLD}${MAGENTA}##### GITHOOK: $hookname"
		echo "$STDIN" | "$hookscript" "$@" || exit_code=$?
		echo ""

		if [[ $exit_code -ne 0 ]]; then
			FAILED+=("$hookname")
		fi
	fi
done < <(
	for key in "${!TO_RUN[@]}"; do
		echo "$key"
	done | sort
)

if [[ "${#FAILED[@]}" -gt 0 ]]; then
	echo -e "${BOLD}${RED}----- ${#FAILED[@]} ${HOOKNAME^^} HOOKS FAILED -----${RESET}\n"
	exit 1
fi

echo -e "${BOLD}${GREEN}----- ALL ${#TO_RUN[@]} ${HOOKNAME^^} HOOKS PASSED -----${RESET}\n"
