#!/usr/bin/env bash

BOLD="\e[1m"
RED="\e[31m"
GREEN="\e[32m"
YELLOW="\e[33m"
RESET="\e[0m"

CONFIG_FILE="$(git rev-parse --show-toplevel)/.commitconfig.json"
COMMIT_MSG=$(head -n1 "$1")

if [[ ! -f "$CONFIG_FILE" ]]; then
	echo -e "${YELLOW}No config file found, skipping...${RESET}"

	exit 0
fi

if ! command -v jq >/dev/null 2>&1; then
	echo -e "${BOLD}It looks like you don't have ${RED}jq${RESET}${BOLD} installed!${RESET}"
	echo
	echo "You can install jq by either using your package manager"
	echo "or downloading it from github:"
	echo
	echo "    https://github.com/jqlang/jq/releases/latest"
	echo

	exit 1
fi

TYPES_REGEX=$(jq -r 'if has("types") then .types | join("|") else "" end' "$CONFIG_FILE")
SCOPES_REGEX=$(jq -r 'if has("scopes") then .scopes | join("|") else "" end' "$CONFIG_FILE")
REVERT=$(jq -r 'if has("revert") then .revert else false end' "$CONFIG_FILE")
MAX_LENGTH=$(jq -r 'if has("maxlength") then .maxlength else 50 end' "$CONFIG_FILE")

if [[ -z $TYPES_REGEX ]]; then
	echo -e "${RED}No/malformed types in config file${RESET}"

	exit 1
fi

REGEX="^(${TYPES_REGEX})(\\((${SCOPES_REGEX:-.+})\\))?!?: .+"

if $REVERT; then
	REGEX="${REGEX}|^([Rr]evert): .+"
fi

if ! [[ $COMMIT_MSG =~ $REGEX ]] || [[ ${#COMMIT_MSG} -gt $MAX_LENGTH ]]; then
	echo -e "${RED}Commit message does not conform to configured standard${RESET}"
	echo
	echo "Your commit message: \"$COMMIT_MSG\""
	echo "Message length: ${#COMMIT_MSG}"
	echo
	echo "Expected format: <type>[optional scope]: <description>"
	echo "Allowed types: $(jq -r '.types | join(" ")' "$CONFIG_FILE")"
	[[ -n $SCOPES_REGEX ]] && echo "Allowed scopes: $(jq -r '.scopes | join(" ")' "$CONFIG_FILE")"
	echo "Allowed maximum length: $MAX_LENGTH"
	echo
	echo "Learn more about conventional commits at:"
	echo
	echo "    https://www.conventionalcommits.org"
	echo

	exit 1
fi

echo -e "${GREEN}Commit message ok${RESET}"
